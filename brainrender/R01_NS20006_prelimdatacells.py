import brainrender
# brainrender.SHADER_STYLE = 'cartoon'
from brainrender.scene import Scene
import pandas as pd
import numpy as np
import os,glob
from matplotlib import cm

scene = Scene()

# scene.add_brain_regions(['VISp'], alpha=.9,use_original_color=True,wireframe=True)

# areas = ['CA1', 'SUB', 'PRE','ProS', 'RSP',
#          'VISa','VISrl','VISal','VISam','VISl','VISpl','VISpm']
# for area in areas:
#     scene.add_brain_regions([area], alpha=.1,
#                             use_original_color=False, color=(237, 37, 144),
#                             wireframe=True)

# tracts = ['scwm','cc','cst','lfbst']
# for tract in tracts:
#     scene.add_brain_regions([tract], alpha=.5, use_original_color=False)
#     scene.actors['root']
#     scene.actors['regions'][tract].flag(tract)
ccf_shape = np.array([1320, 800, 1140*2])
#manually add probes here

probe1 = (np.array([27.56985243, 50.15660916, 26.70418865, 31.45151719, 37.        ,
         9.8174272 , 19.79349573, 14.27927144, 31.59741264, 32.14728682,
        34.34346173, 34.45368223, 49.3508881 , 35.73623173, 35.08941046,
        14.36654614,  5.        , 49.85645265, 35.88395828, 32.24231977,
         5.        , 35.2198021 , 31.05690406, 37.06053658, 35.95889742,
        17.75049284, 53.        , 36.88223936, 20.55766575, 37.        ,
        37.        , 53.        , 37.        , 41.02782605,  5.        ,
        53.        , 44.95330197, 12.61206794, 23.35176447, 53.        ,
        16.36831743, 11.55346511, 19.75314426, 24.57071077, 22.5085943 ,
        27.27235334, 37.47586121, 46.78584586, 15.4907594 , 32.79451768,
        23.48838386, 36.49158543, 37.42740542, 32.19942495, 10.05809953,
        10.66301346, 48.50547001,  7.13315292, 15.60015906, 48.71415825,
        27.6340007 , 30.29352576, 28.09182433, 33.38201733, 42.0738653 ,
        34.01079351, 31.13202659, 46.37364676, 13.63582529, 50.78561525,
        46.05848768, 30.64139503, 13.65953714, 53.        ,  5.        ,
        26.79688505, 42.1666736 , 41.70405564, 53.        , 32.00819428,
        34.93842254, 14.78444896, 46.38294132,  6.45304751, 21.78542378,
        14.03585193, 50.22256716, 49.54957941, 49.11423269, 12.24054795,
         5.        , 20.33013847, 12.03504513, 37.1760989 , 39.11785335,
        40.75408687, 15.60792679, 12.82495278, 33.46214589, 49.97013953,
        33.34450511,  8.49625001, 30.02505842, 45.62201806, 14.03375788,
        37.54199684, 28.41890668, 28.13469412, 27.59985482, 26.42406645,
        37.4260043 , 21.        ,  5.        , 17.20016108, 26.99901655,
        40.74103797, 53.        , 34.52083847, 12.79809391, 44.1892069 ,
        53.        , 12.91585864, 15.66370195,  5.        , 26.00753688,
        47.77296749, 17.25512736, 40.64879129,  7.62845761, 42.67642019,
        21.        ]),
 np.array([3588.99016408, 3372.19578366, 3010.17880873, 2645.64896547,
        1732.02417325, 1551.91093778, 1539.74169589, 1478.06961195,
        1440.06134629, 1414.63181332, 1362.00671554, 1324.3078135 ,
        1315.79049273, 1270.50288407, 1260.79582242, 1260.64150511,
        1250.1571912 , 1248.47572681, 1240.        , 1235.74037009,
        1234.98803624, 1224.57216359, 1222.0214379 , 1201.76477415,
        1197.53702884, 1184.94574677, 1183.06509538, 1160.27725561,
        1159.08006294, 1158.79077543, 1150.79267928, 1143.28798742,
        1142.4035445 , 1140.        , 1137.17906657, 1114.69659857,
        1111.70025607, 1105.22160632, 1066.61495779, 1063.06026092,
        1046.458342  , 1040.        , 1023.67509351, 1017.18247006,
        1016.77996003, 1010.41850122,  996.83806044,  971.89248681,
         946.7264788 ,  935.35025572,  923.45967991,  916.44121355,
         910.14982917,  871.45439599,  864.6636556 ,  846.34814013,
         740.03082247,  723.34095759,  721.17385153,  684.23301006,
         683.01490261,  682.50962306,  669.12639491,  667.1837164 ,
         661.46332932,  659.27948134,  629.89964997,  626.24049319,
         601.24670125,  573.64311771,  541.2217331 ,  533.41973119,
         531.9151411 ,  527.34672271,  487.8046398 ,  444.42287602,
         436.03603072,  414.50725134,  402.17291822,  401.18453839,
         367.46982719,  364.43754192,  363.85728463,  352.70196326,
         348.97124426,  342.53503713,  340.        ,  340.        ,
         337.86496351,  318.55080743,  315.32370254,  302.42147274,
         300.        ,  280.        ,  259.74154734,  246.83204171,
         240.        ,  222.75864725,  222.65419432,  220.        ,
         203.58785883,  200.        ,  200.        ,  191.52127652,
         182.62100744,  180.        ,  180.        ,  177.29616888,
         175.93811606,  175.3189092 ,  171.9270556 ,  170.86350696,
         164.66399577,  163.96462577,  163.19771454,  153.978216  ,
         150.22565455,  120.        ,  118.37859072,   95.25020134,
          83.9262277 ,   80.        ,   80.        ,   67.98136863,
          67.17333486,   65.06494029,   62.50372968,   60.        ,
          34.32155036,   34.05289971,   31.06456372]))
probe2 = (np.array([53.        , 42.18928002,  8.54728529,  8.78011449, 37.        ,
        23.34299438, 31.08733664, 30.76965224, 44.55512054, 34.90639715,
        39.98163506, 46.19350321, 12.80938846, 43.91668467, 32.98996782,
        35.96309164, 24.60442354, 40.05610034, 43.56174449, 53.        ,
        13.12008158, 30.9830624 , 34.8207433 , 30.52891263, 17.19084618,
        28.66287192, 21.8247382 , 45.19642446, 53.        , 33.54350394,
        50.76034953, 18.37828319, 33.64825506, 33.00174786, 53.        ,
        34.19770577, 42.62206583,  8.63774154, 33.24877779, 42.18260537,
        53.        ,  9.4078209 , 15.14775227, 41.48511347, 37.7093947 ,
        32.02569879, 39.81821717, 41.61223008, 41.26360472, 11.74691667,
        41.65687782, 40.65982031, 46.29836026, 37.53785814, 48.54796342,
        39.44112056, 16.91262855, 36.28153566, 25.47335139, 43.97366827,
        49.72778292, 18.18513025, 27.73796112, 30.62310668, 33.60119905,
        44.88550914, 45.32555715, 45.95755613, 49.11960561, 12.89743508,
         8.35912336, 10.04233483, 13.47588374,  8.58826657, 30.895652  ,
        46.66656243, 24.56422779, 48.7541122 , 44.57580288, 44.21358139,
         5.        , 26.16945566, 17.11058282, 49.98675346, 13.4984631 ,
        17.08249319, 18.04588151, 34.24046874, 31.89408348, 24.18525661,
        42.81069515, 53.        , 48.89813949, 44.62811594, 24.9598182 ,
        24.27634119, 36.54236506, 38.11559993, 36.00415257, 15.24112717,
        27.55057961, 29.70978687, 47.10352381, 36.25889967, 48.5316994 ,
        16.27796498, 14.51041435, 15.66484311, 17.46139449, 24.51917434,
         5.        , 32.40284282, 35.97837869, 34.54224498, 38.05101603,
        29.79234867, 22.79530848, 31.78548584, 27.31056292, 15.58170074,
        25.57078395, 53.        , 53.        , 46.78738563, 49.20148056,
         8.24769037, 13.94036471, 23.80756624, 37.9263047 , 31.4780861 ,
        34.92392416, 31.48159139, 15.27546793, 29.24196797, 21.10326402,
        50.65563738, 44.63270882, 53.        , 29.16042365, 50.4585677 ,
        20.43313567, 17.11807802,  9.27136698, 17.61314587, 25.36819582,
        26.32210683, 19.82528111, 16.25421809, 20.69615922, 30.52016355,
        53.        , 44.15716693, 43.17948456,  5.        ,  5.        ,
         5.        , 20.5739487 , 32.57266354, 37.        , 40.60306411,
        17.03099596, 16.88460935, 30.64009807, 11.74571552, 26.15919684,
        19.60625812, 46.31890689, 44.07391612, 36.99585967, 24.84263785,
        34.9062177 , 37.64919095, 26.986337  , 20.06570317, 35.30787613,
        26.46344528, 41.4969827 , 51.25152822, 41.582662  , 48.18744237,
        18.82709687,  5.        , 13.62022387, 36.13206272, 34.57524031,
        35.99731164, 40.71612903, 39.22119586, 16.38346832, 26.97428437,
        49.14354871, 50.82426612, 47.86010764,  5.        ,  8.81079538,
        23.16132085, 32.85691486, 35.23024589, 28.23175347, 17.87961977,
        45.25311667, 46.38407243, 46.58617524,  8.91345498,  9.47548911,
         8.79218551, 34.58176253, 39.81162948, 37.32054704, 34.22728572,
        16.53919153, 21.18040846, 22.92123382, 49.75370187, 42.6984943 ,
         7.7229603 , 11.3093998 ,  8.60058552,  8.69482717, 47.51013552,
        20.22802116, 37.        , 45.9577818 , 32.98665923, 32.51350541,
        49.33456675, 37.70406148, 19.73320532, 16.70246418, 47.10174579,
        44.71676506, 50.75350791, 45.4782607 , 13.370546  ,  5.        ,
        42.43715129, 40.17832034, 47.53306055, 33.93824901, 17.58143143,
        53.        , 53.        , 43.64453769, 42.98046096, 10.12349585,
         7.81505617, 37.        , 44.54387867, 20.40509769, 14.7845336 ,
        10.86960799, 46.67783426, 46.64450884, 43.20207034, 49.1780385 ,
         9.85674484, 42.27469198, 53.        , 49.80557181, 48.99832427,
        42.78579875, 36.95425109, 25.57057262, 37.85448732, 47.24543727,
        49.37085867, 49.73475473, 49.08628316,  5.        , 23.43027442,
        43.22048828, 33.45798292, 41.39184103, 25.92007579, 23.75808242,
        34.81810243, 18.82947614,  9.4264911 , 13.39977769, 15.06690896,
        22.89497649, 22.24095658, 41.27247985, 12.88357826, 36.34761557,
        34.47571847, 47.7818134 , 38.62447478, 53.        , 45.17830127,
        44.82530184, 45.12632972, 49.69665591, 27.30366837, 33.02786483,
        23.62652314, 29.17496994, 29.73083697, 19.69210927, 23.64969405,
        17.50320481, 12.66484812, 35.06300714, 47.16216038, 20.37058749,
         9.33048087, 34.50967441, 34.46965527, 50.13275055,  6.86994642,
        34.32488102, 46.82595438, 34.58426219, 33.08383099, 14.00481232,
         8.63478842, 28.4399274 , 34.26515152, 34.52064823, 46.46205245,
        10.86498704, 33.24963745, 32.0348701 , 21.94582554, 35.80865543,
        15.26812579, 37.        , 10.66633248, 27.20205222, 46.78161459,
        13.17104821, 42.86357726]),
 np.array([3431.93301085, 1695.87081988, 1641.65271805, 1620.        ,
        1615.56849833, 1613.43453171, 1608.60109597, 1597.2735581 ,
        1594.43999934, 1581.26450946, 1577.77252596, 1570.82239452,
        1562.98083857, 1554.43324201, 1532.70646698, 1532.28870767,
        1530.97062522, 1528.33330631, 1526.0276041 , 1523.11355389,
        1521.61252065, 1520.96231911, 1518.65039177, 1513.73591907,
        1493.35518194, 1492.16802619, 1485.21012736, 1480.58715813,
        1471.94019559, 1471.65294488, 1461.5315406 , 1455.65144778,
        1455.11272997, 1449.19560734, 1447.82348688, 1441.44058519,
        1438.99991826, 1431.94328136, 1420.        , 1416.93185305,
        1414.46195838, 1410.35726227, 1409.47567043, 1406.59336497,
        1405.43485821, 1394.53399733, 1393.92155289, 1393.18084252,
        1392.7819121 , 1388.23679813, 1385.05587017, 1384.89399507,
        1384.77745187, 1377.46852569, 1372.72694   , 1363.11714038,
        1361.64038939, 1360.        , 1354.22020551, 1340.        ,
        1340.        , 1335.90941707, 1335.72678929, 1335.41099133,
        1326.79643912, 1323.30605977, 1322.69149627, 1322.42672261,
        1320.4284631 , 1320.        , 1316.8284779 , 1315.73387352,
        1313.73317089, 1313.1130056 , 1308.61566106, 1308.2756411 ,
        1306.82718968, 1304.84055738, 1302.7263201 , 1298.89923579,
        1298.50033212, 1297.79343828, 1292.23940061, 1291.81268187,
        1290.7593415 , 1288.31232297, 1285.03804325, 1284.58677976,
        1282.05072808, 1280.        , 1280.        , 1279.64673136,
        1279.44542791, 1276.38715728, 1274.13846574, 1271.48884799,
        1269.03923495, 1265.92988284, 1264.05787266, 1259.26833558,
        1254.61914205, 1254.42398942, 1249.78185557, 1244.89181873,
        1239.21867216, 1235.25976812, 1234.4709126 , 1233.14349641,
        1218.62877235, 1217.2679912 , 1214.30102979, 1213.10032732,
        1209.82573079, 1208.59097655, 1206.43129332, 1203.41069144,
        1202.10599125, 1200.        , 1199.34700078, 1191.34473057,
        1185.31949243, 1181.87030299, 1177.34291384, 1174.22933539,
        1174.02160005, 1169.33947682, 1169.05315553, 1164.64516128,
        1161.45563284, 1160.        , 1157.4717093 , 1155.73774953,
        1154.08745179, 1153.42169831, 1151.90661305, 1149.99915962,
        1143.07479765, 1139.62463202, 1122.74615009, 1122.40797499,
        1119.8612746 , 1117.63447576, 1113.56171671, 1107.41108785,
        1106.75196749, 1102.26119763, 1102.25958475, 1097.61122556,
        1097.50191874, 1097.00356165, 1093.9529051 , 1091.46064061,
        1082.56166818, 1080.        , 1080.        , 1075.84355901,
        1075.71175646, 1074.119601  , 1071.37290803, 1067.19543882,
        1065.93222739, 1064.11800084, 1061.48175877, 1060.06006556,
        1057.60216507, 1056.85089868, 1051.84487641, 1051.46382936,
        1048.87338037, 1043.83940837, 1041.23655749, 1038.20610978,
        1022.81893822, 1020.        , 1019.18425492, 1016.03235885,
        1012.84433491, 1012.72346845, 1005.82935989, 1004.05961296,
        1002.36032004,  999.43188694,  997.75955052,  997.69022664,
         995.90230972,  994.01550945,  993.10198924,  985.74937478,
         985.71347994,  984.39841802,  983.18276869,  978.32869609,
         977.06227509,  976.19396908,  974.56369417,  973.22712593,
         970.66246896,  970.48188164,  969.66694987,  965.72446195,
         965.59297395,  965.41310108,  962.35350095,  960.17602341,
         958.8030323 ,  956.92315748,  954.70210424,  953.48023721,
         953.18510415,  950.57415243,  947.61367534,  947.61153862,
         947.19859104,  937.95370069,  936.7555965 ,  934.03705792,
         932.79225704,  930.27272915,  926.05310621,  925.31647417,
         921.18497859,  920.71480267,  910.41945012,  909.72927246,
         908.77918259,  908.64632546,  907.3914647 ,  906.34288637,
         905.79591419,  905.12732564,  905.08313265,  901.06188183,
         900.05075963,  892.08885104,  889.45096286,  887.78153505,
         887.22273937,  887.16619465,  886.9456522 ,  880.        ,
         864.86177148,  852.4884921 ,  843.28126916,  840.31695005,
         840.        ,  833.5352297 ,  832.16577722,  828.80347026,
         821.91922954,  820.99982887,  818.1163797 ,  810.47166203,
         810.23674105,  810.07210251,  806.89774727,  806.20223482,
         802.77426534,  795.8010958 ,  795.40624224,  793.7606823 ,
         784.11266797,  781.23232503,  766.3695901 ,  757.23010561,
         756.73323169,  752.56526423,  735.90972866,  735.0490756 ,
         721.71058998,  717.97310962,  716.04981371,  711.94823226,
         705.56504573,  697.83449584,  692.90737086,  684.26007664,
         674.98633033,  669.45353195,  668.35576704,  657.99567112,
         644.86912343,  633.68701932,  629.1045254 ,  612.86623438,
         612.68469034,  607.63839972,  580.        ,  573.88715603,
         570.73153307,  553.06131499,  540.        ,  538.47148338,
         534.6304504 ,  523.81299459,  520.30295923,  518.58890793,
         515.47158468,  515.22882353,  504.55512774,  500.33406543,
         500.        ,  497.31303568,  494.53410781,  488.59537664,
         487.72601714,  487.10066829,  486.43541742,  485.47966376,
         485.04085727,  481.01767997,  476.09723347,  460.        ,
         457.06811477,  455.20235244,  453.06346254,  440.18791655,
         433.11404371,  427.14395938,  424.45655673,  415.81294539,
         411.49187901,  409.06076422,  403.80580604,  402.61700356,
         402.30083678,  396.9147804 ,  396.08141882,  364.72514312,
         364.43410661,  360.        ,  313.51339998,  220.        ]))

prob1 = pd.read_csv('/Users/danieljdenman/github/djd_notebooks/brainrender/df.csv').dropna()
prob2 = pd.read_csv('/Users/danieljdenman/github/djd_notebooks/brainrender/df2.csv').dropna()

start = [[860,80 , 300,], [860,20, 300,]]
end = [[1210,300,335 ],[800,300,300 ]]
for i,prob in enumerate([prob1,prob2]):
    prob['x'] =  start[i][0]*10 + prob['x'] + prob['y']/1800. * (end[i][0] - start[i][0])*10  #+ ccf_shape[0]
    # prob['x'] = np.linspace(start[0],end[i][0],np.max(prob['xpos'].values))[prob.xpos.values.astype(int)]+ccf_shape[0]
    prob['y'] = start[i][1]*10 + prob['y']/1800. * (end[i][1] - start[i][1])*10 
    prob['z'] = ccf_shape[2]*5 - start[i][2]*10 + prob['z'] + prob['y']/1800. * (end[i][2] - start[i][2])*10 
    prob['size'] = prob['rate'].values/10. 
    prob['mod'] = prob['mod']


probes = [(np.array([[880,-230,-300,],[880,130,-300]]),'k',30),
          (np.array([[880,-230,-320,],[880,130,-320]]),'k',30),
        #   (np.array([[895,15 ,-335,],[895,290,-90 ]]),(229,191,80),100),
        #    (np.array([[895,15 ,-335,],[635,290,-335 ]]),(229,191,80),100),
        #   (np.array([[0,-250,0,],[0,134,0]]),'r'),
         ]
for probe_points in probes:
    scene.add_probe_from_coordinates(ccf_shape + probe_points[0],color=probe_points[1],radius =probe_points[2])

import matplotlib.cm as cm
cmap = cm.get_cmap('inferno')
scene.add_cells(prob1[prob1['color']<=0.01],radius=100,res=10,color=cmap(prob1['color'][prob1['color']<=0.01].values/2.)[:,:3],alpha=0.1)
scene.add_cells(prob1[prob1['color']>=0.01],radius=100,res=10,color=cmap(prob1['color'][prob1['color']>=0.01].values/2.)[:,:3],alpha=1)
scene.add_cells(prob2,radius=100,res=10,color=cmap(prob2['color'].values/2.)[:,:3],alpha=0.1)




# path = '/Users/danieljdenman/Academics/grants/20200602_r01BRAIN/figs/'
# filename = 'br'+len(glob.glob(os.path.join(path,'br*')))+'.png'
# scene.export_for_web(os.path.join(path,filename))

scene.render()


# np.linspace(start[0],end[i][0],np.max(prob['pxos'].values))[prob.xpos.values.astype(int)]
# np.linspace(start[0],end[i][0],)

